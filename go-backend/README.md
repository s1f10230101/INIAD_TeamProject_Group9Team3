# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## è¨­è¨ˆåŸå‰‡
1. **ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**
  - OpenAPIä»•æ§˜æ›¸ã‚’oapi-codegenã§ã‚¹ã‚­ãƒ¼ãƒã‚’Goã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
  - sqlcã§SQLã‚¯ã‚¨ãƒªã‚’å‹å®‰å…¨ã«æ‰±ã†
2. **å±¤åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**
  - Handler, Usecase, Repositoryã®3å±¤ã«åˆ†å‰²
  - å„å±¤ã¯Interfaceã‚’ä»‹ã—ã¦ç–çµåˆã«è¨­è¨ˆ
3. **ä¾å­˜æ€§ã®é€†è»¢**
  - ä¸Šä½å±¤ãŒä¸‹ä½å±¤ã«ä¾å­˜ã—ãªã„(ä¸‹ä½å±¤ã‚’å…¥ã‚Œæ›¿ãˆå¯èƒ½)ã‚ˆã†ã«è¨­è¨ˆ
  - å…·ä½“çš„ãªå®Ÿè£…ã¯main.goã§çµ„ã¿ç«‹ã¦ã‚‹

## ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [oapi-codegen]
  - OpenAPIä»•æ§˜æ›¸ã‹ã‚‰Goã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«
  - `go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - `oapi-codegen --config=oapi/oapi_config.yaml ../openapi.1.0.yaml` ã§ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
- [air]
  - Goè£½ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«
  - `go install github.com/air-verse/air` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - `air -c ./cmd/server/.air.toml` ã§æœ¬ç•ªç’°å¢ƒç”¨ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰èµ·å‹•
  - `air -c ./cmd/inmemoryserver/.air.toml` ã§ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDBã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰èµ·å‹•
- [sqlc]
  - SQLã‹ã‚‰Goã®ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«
  - `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - `sqlc generate` ã§ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
- [golang-migrate]
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«
  - `go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - `migrate create -ext sql -dir db/migration -seq <name>` ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
  - `migrate -database "postgres://..." -path db/migration up` ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
  - ãŸã ã—ã€ç¾åœ¨ã¯main.goã§migrateã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãŸã‚ã€æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ã¯ãªã„
## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```plaintext
.
â”œâ”€â”€ api/
â”‚   â””â”€â”€ server.gen.go   # ğŸ‘ˆ OpenAPI Codegenã§è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
â”œâ”€â”€ main.go         # ğŸ‘ˆ å„ãƒ‘ãƒ¼ãƒ„ã‚’çµ„ã¿ç«‹ã¦ã¦èµ·å‹•ã™ã‚‹å½¹ç›®ã«ç‰¹åŒ–
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/        # ğŸ“¦ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ‰±ã†å±¤
â”‚   â”‚   â””â”€â”€ post.go
â”‚   â”‚   â””â”€â”€ post_test.go
â”‚   â”œâ”€â”€ usecase/        # ğŸ§  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”‚   â””â”€â”€ repository/     # ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ï¼ˆä¿å­˜ãƒ»å–å¾—ï¼‰ã‚’æ‹…ã†å±¤
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum
```
* **Handlerå±¤**
  - HTTPã®ä¸–ç•Œã®è¨€è‘‰ã‚’è©±ã—ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€Usecaseã«å‡¦ç†ã‚’ä¾é ¼ã—ã€çµæœã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
* **Usecaseå±¤** 
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ¬ä½“ã§ã™ã€‚HTTPã®ã“ã¨ã¯ä½•ã‚‚çŸ¥ã‚Šã¾ã›ã‚“ã€‚ã€ŒæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã€ã¨ã„ã£ãŸç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…å½“ã—ã¾ã™ã€‚
* **Repositoryå±¤**
  - ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€ã§ã™ã€‚Usecaseã‹ã‚‰ä¾é ¼ã‚’å—ã‘ã¦ã€ãƒ¡ãƒ¢ãƒªã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»å–å¾—ã—ã¾ã™ã€‚  

## å†…éƒ¨è¨­è¨ˆ(ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
### 1. Spot, Review, Userã®åŸºæœ¬ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£(Spot, Review, User)ã”ã¨ã«CRUDæ“ä½œã‚’æä¾›
- Handlerã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’UsecaseãŒå—ã‘å–ã‚Šã€Repositoryã«å‡¦ç†ã‚’ä¾é ¼ã€PostgreSQLã«æ°¸ç¶šåŒ–

### 2. AIãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
AIã«ã‚ˆã‚‹æ—…è¡Œãƒ—ãƒ©ãƒ³ç”Ÿæˆã¯ã€RAG (Retrieval-Augmented Generation) ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚å…¨ä½“çš„ãªãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿”ç­”ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³:
```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Handler as Handler
    participant Usecase as AIGPTUsecase
    participant Repo as SpotRepository
    participant OpenAI as OpenAI API

    User->>Handler: æ—…è¡Œãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)
    Handler->>Usecase: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã™
    Usecase->>Repo: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ä¸€è‡´ã™ã‚‹è¦³å…‰åœ°æƒ…å ±ã‚’æ¤œç´¢(RAGã®Retrieval)
    Repo-->>Usecase: è¦³å…‰åœ°æƒ…å ±ã‚’è¿”ã™
    Usecase->>Usecase: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨è¦³å…‰åœ°æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
    Usecase->>OpenAI: Chat Completion APIã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§å‘¼ã³å‡ºã—
    OpenAI-->>Usecase: AIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å—ã‘å–ã‚‹
    Usecase-->>Handler: éšæ™‚æ›¸ãè¾¼ã¿è¿”ç­”
    Handler-->>User: ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æµã™
```

## ãƒ†ã‚¹ãƒˆ
- å„å±¤ã”ã¨ã«ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…
- ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦
  - dbãªã©ã®å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã¯`//go:build integration`ã§ãƒ“ãƒ«ãƒ‰ã‚¿ã‚°ã‚’ä»˜ä¸ã—ã¦åˆ†é›¢
  - `go test ./... -v` ã§çµ±åˆãƒ†ã‚¹ãƒˆä»¥å¤–ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  - çµ±åˆãƒ†ã‚¹ãƒˆå«ã‚€å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    - `docker compose up db -d`ã§ä¾å­˜é–¢ä¿‚ã®èµ·å‹•
    - `cp .env.example .env`ã§ç’°å¢ƒå¤‰æ•°ã®è¨­å®š(å¿…è¦ã«å¿œã˜ã¦ç·¨é›†)
    - `migrate -path db/migration -database "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}?sslmode=disable" up`ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
    - `go test -tags="integration" ./... -v`ã§çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
  - æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
    - OpenAIã®APIã‚’ä½¿ã£ãŸæœ¬ç•ªãƒ†ã‚¹ãƒˆã¯æ‰‹å‹•ã§å®Ÿè¡Œã—äººé–“ãŒçµæœã‚’ç¢ºèªã—ã¾ã™
    - Planç”Ÿæˆãƒ†ã‚¹ãƒˆ
      1. `docker compose up --build --watch`ã§èµ·å‹•
      2. `curl -X POST -H "Content-Type: application/json" -d '{"prompt": "ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã§ã™"}' http://localhost:8080/v1/plans`ã§ãƒ†ã‚¹ãƒˆæŠ•ç¨¿

## ãã®ä»–
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ä¾å­˜
  - OpanAI ChatGPT API
